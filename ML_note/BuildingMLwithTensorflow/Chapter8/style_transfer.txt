Image Style Transfer Using CNN
文章 model

A Neural Algorithm of Artistic Style

摘要
不同风格图像的语义内容一直是很难表达的，因为缺乏对这一概念的直观描述(representation)来将'style'这一概念从一幅图中剥离出来，即区分何为style何为content。 我们用的模型基础是CNN以及一种叫Neural Algorithm of Artistic Style 的算法来分离重组图像的style和content。


引言
Style转变属于texture转换问题，目标是从源图像中提取合成材质，并用目标图像的内容加以限制。目前已经有很多非参数算法可以通过对源图像像素重抽样合成很逼真的自然材质。目前最潮的技术基于该非参数算法的同时还使用各种技巧保留目标图片的结构。

但是过往算法有一个普遍的缺点，就是使用低级别的图像特征来指引材质转换。合理的做法应当能提取图片的含义，作为材质转换的重要依据。所以，好模型的基本前提是具备良好的描述方式，能够独立地分析图片含义和风格的变化。目前能做到这种程度的模型多是对图片有所限制，比如不同亮度条件下的人脸识别、不同字体的字母或者手写数字、门牌号等。

使模型具普遍分析能力还是相当困难的。不过近期发展的Deep CNN已经能制造强大的电脑视觉系统可以提取图片高级别的含义。另外，经足够多标签图特别训练（如物体识别）过的CNN可以通过训练图片集归纳的一般特征(generic feature)中提取高级别的图片内容，甚至可以应用与其他视觉信息处理任务，如材质识别、艺术风格分类等。


本文中，我们将展示如何使用CNN归纳的一般特征独立地操控图片的风格和内容。另外也介绍一种新算法Neural Algorithm of Artistic Style用于风格转换。其理念是在材质转换的基础上添加对材质生成的限制，该限制方法是由最先进的CNN模拟出的。由于材质模型也是基于深度图片描述，所以风格转换可以巧妙地转换为单个NN下的最优化问题。New images are generated by performing a pre-image search to match feature representations of example images （新图片的产生是通过搜索与样本图片的特征相对应的图片）。这个方法以前有人用在材质形成模型中，用于优化深度图片描术的理解力。我们的风格转换算法结合了基于CNN的参数材质模型和一个用于逆转CNN提取的图片描述的方法。


下述结果是通过VGG网络得出的，VGG的训练时基于物体识别和定位。所以给定的图片，会经过CNN每一层相应卷积核的编码。我们做的修改是：添加归一化层，使得每个卷积层的计算结果均值为1；不使用全连接层；在图片生成中，我们使用平均pooling而不是maximum pooling。



含义描述

若某一层内含N_l个卷积核，那么就有N_l个特征图，每个特征图的尺寸为M_l(特征图的长*宽)。计算结果将存在大小为N_l\times M_l的矩阵中，该计算就是Activation Function。

若要观察不同层所编码的图片信息，可以对白噪图进行梯度下降来制造与原图特征相对应的人造图，如图1中的内容重塑过程。具体过程是，先定义error function为白噪图和原图的在l层计算得出的特征描述之间的差值的平方。然后对error function求导，发现导数就是两个矩阵各element-wise差值，使用back propagation计算gradient，依据gradient调整白噪图直到其产生的特征描述矩阵与原图一致。

当CNN用于物体识别时，它的层次越深，对物体信息的描述就越明显。因此，在VGG网络中训练，层次越深，对原图的描述就越来越注重（sensitive）对其含义的描述，对其准确的外观就越不在意（invariant）。因此，较深的层次捕捉较高级别的含义（相对于物体和其在原图中的排列方式），而对具体像素值是否接近原图不做过多限制（像素值显然是低层级的图片含义）。同理，较浅的层次就只是简单的重造了与原图接近的像素值。我们称深层次的特征计算为含义描述。



风格转换

就是制造一个新的图，使得其同时对应原图的含义描述和风格借鉴图的风格描述。即对白噪图同时最小化和原图的含义描述差异，以及和风格借鉴图的风格描述差异。通过实验，发现L-BFGS方法用于计算最优解最好。为了能够处理大型图片，我们先将风格借鉴图重塑为相同尺寸。另外，我们没有用原图对生成图进行正则化。虽然可以将低层次卷积层计算的材质特征看作风格借鉴图的前量信息（image prior）。总error function是含义ef和风格ef的加权平均




结论

主要结论就是，CNN对含义和风格的鉴别是比较明显的。即可以独立地运用含义或风格制造新的有意义的图片。

含义和风格的取舍

当然，含义和风格不可能完全独立开。因此不可能制造出完全符合图a内容和图b风格的图片。因此在总error function的权重选择就决定了我们是更偏向原图还是更偏向风格图。

CNN中不同层级的效果

还有一个重要因素是选择CNN中各层次的作用（负责含义还是风格的捕捉）。前面提到，风格描述是NN中多层级参与的多尺度描述。用多少层，以及层次的位置决定了风格匹配所依据的当前层次的尺度信息。我们发现，匹配风格描述涉及的层次越高，对原图结构的保持就越明显，可以制造更平滑、更连续的图像。而为了研究对含义描述的捕捉，我们研究了到不同层次生成的图片的含义表现情况。图5可以看出，在浅的层次，含义主要靠像素值体现，生成的图片很想简单地把两张图混在一起。而到了更高的层次，由于含义描述对低等级特征的限制减少，生成的图片很好地结合了原图的含义和风格图的风格。即色彩和边缘与风格图一致而内容仍然是原图。

梯度下降的开端

前述我们使用的都是白噪图作为原始图用来生成合成图。但其实可以使用含义图或风格图，而且两者制造的合成图看起来没有太大的差距。值得注意的是，只有白噪图（本身是随机的）才能生成不同的合成图。若用确定的图作为原始图，那么生成的合成图都是基本一样的（梯度下降过程中还是存在随机性）。

逼真的风格转换

目前的研究还是用艺术作品的风格作为转换依据。但其实我们的算法可以应用在任意图上（比如艺术作品作为含义图，照片作为风格图）。



